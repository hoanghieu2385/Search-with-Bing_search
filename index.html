<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bing Auto Search</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
      body {
        background-color: #f0f2f5;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        font-family: sans-serif;
      }
      .bing-tool {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 450px;
        text-align: center;
      }
      .bing-tool__header {
        margin-bottom: 1.5rem;
      }
      .bing-tool__title {
        font-size: 1.8rem;
        font-weight: bold;
        color: #333;
      }
      .bing-tool__status {
        font-size: 1.1rem;
        font-weight: 500;
        padding: 0.8rem;
        border-radius: 8px;
        background-color: #e9ecef;
        margin-bottom: 1.5rem;
        transition: background-color 0.3s;
      }
      .bing-tool__status.searching {
        background-color: #fff3cd;
        color: #664d03;
      }
      .bing-tool__status.stopped {
        background-color: #f8d7da;
        color: #58151c;
      }
      .bing-tool__controls {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
        margin-bottom: 1.5rem;
      }
      .bing-tool__button {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: bold;
        padding: 0.6rem 1rem;
      }
      .settings__panel {
        text-align: left;
        margin-top: 1rem;
        padding: 1rem;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #f8f9fa;
      }
      .settings__toggle {
        text-decoration: none;
        font-weight: bold;
        color: #0d6efd;
      }
    </style>
  </head>
  <body>
    <div class="bing-tool">
      <div class="bing-tool__header">
        <h1 class="bing-tool__title">Bing Search Tool</h1>
      </div>

      <div id="status-display" class="bing-tool__status">Sẵn sàng!</div>

      <div class="bing-tool__controls">
        <button id="btn-start" class="btn btn-primary bing-tool__button"><i class="fas fa-play"></i> Bắt đầu</button>
        <button id="btn-stop" class="btn btn-danger bing-tool__button" style="display: none">
          <i class="fas fa-stop"></i> Dừng
        </button>
        <a href="https://rewards.bing.com/" target="_blank" class="btn btn-success bing-tool__button">
          <i class="fas fa-star"></i> Điểm
        </a>
      </div>

      <div class="bing-tool__settings">
        <a class="settings__toggle" data-bs-toggle="collapse" href="#settings-panel" role="button">
          <i class="fas fa-cog me-2"></i>Cài đặt
        </a>
        <div class="collapse show settings__panel" id="settings-panel"></div>
      </div>
    </div>

    <script>
      // === SCRIPT XỬ LÝ TAB TRUNG GIAN (TỰ ĐỘNG ĐÓNG) ===
      const urlParams = new URLSearchParams(window.location.search);
      const autoCloseTime = urlParams.get('autoClose');
      const searchQuery = urlParams.get('q'); // Lấy thêm chủ đề tìm kiếm

      // Nếu có cả 2 tham số, đây là tab tự động đóng
      if (autoCloseTime && searchQuery) {
        // 1. Thực hiện tìm kiếm trong nền bằng iframe ẩn
        const bingUrl = `https://www.bing.com/search?q=${encodeURIComponent(searchQuery)}`;
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none'; // Giữ cho nó vô hình
        iframe.src = bingUrl;
        document.body.appendChild(iframe); // Thêm vào trang để kích hoạt tải

        // 2. Hiển thị đếm ngược và lên lịch đóng tab
        let timeLeft = parseInt(autoCloseTime, 10);
        document.body.innerHTML = `<div style="display:flex; flex-direction:column; justify-content:center; align-items:center; height:100vh; font-size:2rem; font-family:sans-serif; color:#333;">
            <div id="countdown">Tự động đóng sau: ${timeLeft}s</div>
            <p style="font-size:1.1rem; color:#555; margin-top: 1rem;">Đang tìm kiếm: <strong>${searchQuery}</strong></p>
            <p style="font-size:0.9rem; color:#777;">Đây là tab tìm kiếm tự động.</p>
          </div>`;

        const countdownElement = document.getElementById('countdown');
        const interval = setInterval(() => {
          timeLeft--;
          if (countdownElement) countdownElement.innerText = `Tự động đóng sau: ${timeLeft}s`;
          if (timeLeft <= 0) {
            clearInterval(interval);
            window.close();
          }
        }, 1000);
      }
      // Nếu không có tham số, chạy logic công cụ chính
      else {
        document.addEventListener('DOMContentLoaded', () => {
          // === DOM ELEMENTS ===
          const startButton = document.getElementById('btn-start');
          const stopButton = document.getElementById('btn-stop');
          const statusDisplay = document.getElementById('status-display');
          const settingsPanel = document.getElementById('settings-panel');

          // === STATE VARIABLES ===
          const STORAGE_KEY = 'bingSearchTracker';
          const allSearchTopics = [
            'Bí ẩn về Atlantis',
            'Câu chuyện về El Dorado',
            'Hệ sinh thái rừng Amazon',
            'Rạn san hô Great Barrier',
            'Động vật nguy cấp',
            'Khám phá đáy đại dương',
            'Hành trình lên sao Hỏa',
            'Kính viễn vọng James Webb',
          ];
          let usedTopicsToday = [];
          let sessionCount = 0; // Đếm số lần tìm trong phiên hiện tại
          let isSearching = false;
          let searchInterval;

          // === HELPER FUNCTIONS ===
          const isMobile = () =>
            /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
          const getTodaysDate = () => new Date().toISOString().slice(0, 10);
          const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

          // === CORE LOGIC ===
          const loadState = () => {
            const storedData = localStorage.getItem(STORAGE_KEY);
            if (storedData) {
              const parsedData = JSON.parse(storedData);
              if (parsedData.date === getTodaysDate()) {
                usedTopicsToday = parsedData.usedTopics || [];
              }
            }
          };

          const saveState = () => {
            localStorage.setItem(
              STORAGE_KEY,
              JSON.stringify({ date: getTodaysDate(), usedTopics: usedTopicsToday })
            );
          };

          const updateUI = () => {
            if (isSearching) {
              startButton.style.display = 'none';
              stopButton.style.display = 'inline-flex';
            } else {
              startButton.style.display = 'inline-flex';
              stopButton.style.display = 'none';
            }
          };

          const stopSearch = () => {
            isSearching = false;
            clearTimeout(searchInterval); // Dùng clearTimeout thay vì clearInterval
            statusDisplay.innerHTML = `Đã dừng. Mở được ${sessionCount} tab.`;
            statusDisplay.className = 'bing-tool__status stopped';
            updateUI();
          };

          // Hàm này là cốt lõi: tìm chủ đề mới và mở tab
          const performSingleSearch = (params = {}) => {
            const availableTopics = allSearchTopics.filter((topic) => !usedTopicsToday.includes(topic));
            if (availableTopics.length === 0) {
              statusDisplay.innerHTML = 'Hết chủ đề mới trong danh sách!';
              if (isSearching) stopSearch();
              return false; // Báo hiệu tìm kiếm thất bại
            }

            const randomTopic = availableTopics[Math.floor(Math.random() * availableTopics.length)];
            usedTopicsToday.push(randomTopic);
            saveState(); // Lưu ngay chủ đề đã dùng

            // *** THAY ĐỔI QUAN TRỌNG: Mở trang của chính bạn với tham số ***
            let searchURL = `${window.location.pathname}?q=${encodeURIComponent(randomTopic)}`;
            if (params.autoCloseDelay) {
              searchURL += `&autoClose=${params.autoCloseDelay}`;
            }

            try {
              const openedTab = window.open(searchURL, '_blank');
              if (!openedTab) throw new Error('Pop-up bị chặn!');
              return true; // Báo hiệu thành công
            } catch (error) {
              alert('Không thể mở tab mới. Vui lòng kiểm tra và cho phép Pop-up cho trang này!');
              usedTopicsToday.pop(); // Hoàn lại trạng thái vì mở tab thất bại
              saveState();
              if (isSearching) stopSearch();
              return false;
            }
          };

          const startDesktopSearch = () => {
            if (isSearching) return;
            sessionCount = 0; // Reset bộ đếm mỗi khi bắt đầu
            isSearching = true;
            updateUI();

            const performAndScheduleNext = () => {
              if (!isSearching) return;

              if (performSingleSearch()) {
                sessionCount++;
                const delayConfig = document.getElementById('slc-delay').value.split('-').map(Number);
                const delay = getRandomInt(delayConfig[0], delayConfig[1]);
                statusDisplay.innerHTML = `Đã mở: ${sessionCount} tab. Chờ ${delay}s...`;
                statusDisplay.className = 'bing-tool__status searching';
                searchInterval = setTimeout(performAndScheduleNext, delay * 1000);
              }
            };
            performAndScheduleNext();
          };

          // === INITIALIZATION ===
          const initialize = () => {
            loadState();

            if (isMobile()) {
              // --- GIAO DIỆN & LOGIC CHO MOBILE ---
              startButton.innerHTML = `<i class="fas fa-search"></i> Mở Tab tìm mới`;
              statusDisplay.innerHTML = `Sẵn sàng mở tab tự động đóng`;

              settingsPanel.innerHTML = `
              <div class="settings__item">
                <label for="slc-close-delay" class="form-label">Tự động đóng tab sau:</label>
                <select class="form-select" id="slc-close-delay">
                  <option value="5">5 giây</option>
                  <option value="12" selected>10-15 giây (Ngẫu nhiên)</option>
                  <option value="22">15-30 giây (Ngẫu nhiên)</option>
                  <option value="300">5 phút</option>
                </select>
              </div>`;

              const getMobileDelay = () => {
                const select = document.getElementById('slc-close-delay');
                if (select.value === '12') return getRandomInt(10, 15);
                if (select.value === '22') return getRandomInt(15, 30);
                return parseInt(select.value, 10);
              };

              startButton.addEventListener('click', () => {
                performSingleSearch({ autoCloseDelay: getMobileDelay() });
              });
            } else {
              // --- GIAO DIỆN & LOGIC CHO DESKTOP ---
              statusDisplay.innerHTML = `Nhấn "Bắt đầu" để tìm kiếm tự động`;

              settingsPanel.innerHTML = `
              <div class="settings__item">
                <label for="slc-delay" class="form-label">Thời gian chờ giữa các lần tìm:</label>
                <select class="form-select" id="slc-delay">
                  <option value="3-5" selected>3 - 5 giây (Nhanh)</option>
                  <option value="5-10">5 - 10 giây (Khuyên dùng)</option>
                  <option value="10-15">10 - 15 giây (An toàn)</option>
                  <option value="15-20">15 - 20 giây (Rất an toàn)</option>
                </select>
              </div>`;

              startButton.addEventListener('click', startDesktopSearch);
              stopButton.addEventListener('click', stopSearch);
            }
          };

          initialize();
        });
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>