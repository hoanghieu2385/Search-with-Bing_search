<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bing Auto Search Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="bing-tool">
      <div class="bing-tool__header">
        <h1 class="bing-tool__title">Bing Auto Search</h1>
      </div>

      <div id="status-display" class="bing-tool__status">Sẵn sàng để bắt đầu</div>

      <div class="bing-tool__controls">
        <button id="btn-start" class="btn btn-primary bing-tool__button"><i class="fas fa-play me-2"></i>Start</button>
        <button id="btn-stop" class="btn btn-danger bing-tool__button" disabled>
          <i class="fas fa-stop me-2"></i>Stop
        </button>
      </div>

      <div class="bing-tool__settings">
        <a
          class="settings__toggle"
          data-bs-toggle="collapse"
          href="#settings-panel"
          role="button"
          aria-expanded="false"
          aria-controls="settings-panel"
        >
          <i class="fas fa-cog me-2"></i>Cài đặt
        </a>
        <div class="collapse settings__panel" id="settings-panel">
          <div class="settings__item">
            <label for="slc-limit" class="form-label">Số lần tìm kiếm:</label>
            <select class="form-select" id="slc-limit">
              <option value="15">15 lần</option>
              <option value="25">25 lần</option>
              <option value="35" selected>35 lần (Mặc định)</option>
              <option value="45">45 lần</option>
              <option value="custom">Tùy chọn</option>
            </select>
          </div>
          <div class="settings__item">
            <label for="slc-interval" class="form-label">Khoảng thời gian:</label>
            <select class="form-select" id="slc-interval">
              <option value="5000">5 giây</option>
              <option value="10000">10 giây</option>
              <option value="random_5_10" selected>Random 5-10s (Mặc định)</option>
              <option value="random_10_15">Random 10-15s</option>
            </select>
          </div>
          <div class="settings__item form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="slc-multitab" checked />
            <label class="form-check-label" for="slc-multitab">Chế độ Multi-tab</label>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // Lấy các element cần tương tác
        const startButton = document.getElementById('btn-start');
        const stopButton = document.getElementById('btn-stop');
        const statusDisplay = document.getElementById('status-display');

        // Tên key để lưu trong localStorage
        const STORAGE_KEY = 'bingSearchTracker';

        // Danh sách TẤT CẢ các chủ đề có thể tìm kiếm
        const allSearchTopics = [
          'Công thức nấu phở bò Hà Nội',
          'Lịch sử triều đại nhà Trần',
          'Các loại cây cảnh dễ trồng trong nhà',
          'Hướng dẫn học lập trình Python',
          'Các địa điểm du lịch Hà Giang',
          'Tóm tắt phim Inception',
          'Giá trị dinh dưỡng của quả bơ',
          'Sửa lỗi màn hình xanh Windows',
          'Tiểu sử nhà văn Nam Cao',
          'Cập nhật thị trường chứng khoán',
          'Học thuyết tiến hóa của Darwin',
          'Những cuốn sách hay nên đọc',
          'Cách chăm sóc da mặt bị mụn',
          'So sánh iPhone và Samsung',
        ];

        // Biến để lưu trạng thái của ngày hôm nay
        let usedTopicsToday = [];

        // =================================================================
        // == LOGIC CHÍNH ĐỂ CHỐNG LẶP LẠI ==
        // =================================================================

        // Hàm lấy ngày hiện tại theo định dạng YYYY-MM-DD
        function getTodaysDate() {
          const today = new Date();
          const year = today.getFullYear();
          const month = String(today.getMonth() + 1).padStart(2, '0');
          const day = String(today.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
        }

        // Hàm tải trạng thái từ localStorage khi khởi động
        function loadState() {
          const storedData = localStorage.getItem(STORAGE_KEY);
          const today = getTodaysDate();

          if (storedData) {
            const parsedData = JSON.parse(storedData);
            // Nếu ngày đã lưu là ngày hôm nay, ta tải lại danh sách đã dùng
            if (parsedData.date === today) {
              usedTopicsToday = parsedData.usedTopics;
            } else {
              // Nếu là ngày mới, ta reset localStorage
              localStorage.removeItem(STORAGE_KEY);
            }
          }
          updateStatus();
        }

        // Hàm lưu trạng thái vào localStorage
        function saveState() {
          const state = {
            date: getTodaysDate(),
            usedTopics: usedTopicsToday,
          };
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        // Hàm cập nhật dòng trạng thái
        function updateStatus() {
          const remaining = allSearchTopics.length - usedTopicsToday.length;
          statusDisplay.innerHTML = `Sẵn sàng! Còn lại <span class="fw-bold">${remaining}</span> chủ đề.`;
        }

        // Hàm thực hiện tìm kiếm ngẫu nhiên
        function performRandomSearch() {
          // 1. Lọc ra danh sách các chủ đề CHƯA được tìm trong hôm nay
          const availableTopics = allSearchTopics.filter((topic) => !usedTopicsToday.includes(topic));

          // 2. Kiểm tra xem còn chủ đề nào không
          if (availableTopics.length === 0) {
            statusDisplay.innerText = 'Bạn đã tìm hết chủ đề cho hôm nay!';
            startButton.disabled = true; // Vô hiệu hóa nút Start
            return; // Dừng hàm
          }

          // 3. Lấy một chủ đề ngẫu nhiên từ danh sách CÒN LẠI
          const randomIndex = Math.floor(Math.random() * availableTopics.length);
          const randomTopic = availableTopics[randomIndex];

          // 4. Thêm chủ đề vừa chọn vào danh sách đã dùng
          usedTopicsToday.push(randomTopic);

          // 5. Lưu lại trạng thái mới vào localStorage
          saveState();

          // 6. Cập nhật giao diện
          const remaining = allSearchTopics.length - usedTopicsToday.length;
          statusDisplay.innerHTML = `Đã tìm: <span class="fw-bold">"${randomTopic}"</span>. Còn lại: ${remaining}`;

          // 7. Tạo URL và mở tab mới
          const searchURL = `https://www.bing.com/search?q=${encodeURIComponent(randomTopic)}`;
          window.open(searchURL, '_blank');
        }

        // Hàm xử lý khi nhấn Start
        function handleStart() {
          startButton.disabled = true;
          performRandomSearch();
          setTimeout(() => {
            // Kích hoạt lại nút nếu vẫn còn chủ đề
            if (allSearchTopics.length - usedTopicsToday.length > 0) {
              startButton.disabled = false;
            }
          }, 1000);
        }

        // =================================================================

        // Gán sự kiện và khởi chạy
        startButton.addEventListener('click', handleStart);
        stopButton.style.display = 'none'; // Ẩn nút Stop

        // Tải trạng thái ngay khi trang được mở
        loadState();
      });
    </script>
  </body>
</html>
