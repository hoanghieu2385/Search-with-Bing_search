<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bing Auto Search</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
      body {
        background-color: #f0f2f5;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        font-family: sans-serif;
      }
      .bing-tool {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 450px;
        text-align: center;
      }
      .bing-tool__header {
        margin-bottom: 1.5rem;
      }
      .bing-tool__title {
        font-size: 1.8rem;
        font-weight: bold;
        color: #333;
      }
      .bing-tool__status {
        font-size: 1.1rem;
        font-weight: 500;
        padding: 0.8rem;
        border-radius: 8px;
        background-color: #e9ecef;
        margin-bottom: 1.5rem;
        transition: background-color 0.3s;
      }
      .bing-tool__status.searching {
        background-color: #fff3cd;
        color: #664d03;
      }
      .bing-tool__status.done {
        background-color: #d1e7dd;
        color: #0f5132;
      }
      .bing-tool__controls {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
        margin-bottom: 1.5rem;
      }
      .bing-tool__button {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: bold;
        padding: 0.6rem 1rem;
      }
      .settings__panel {
        text-align: left;
        margin-top: 1rem;
        padding: 1rem;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #f8f9fa;
      }
      .settings__toggle {
        text-decoration: none;
        font-weight: bold;
        color: #0d6efd;
      }
    </style>
  </head>
  <body>
    <div class="bing-tool">
      <div class="bing-tool__header">
        <h1 class="bing-tool__title">Bing Search Tool</h1>
      </div>

      <div id="status-display" class="bing-tool__status">Sẵn sàng!</div>

      <div class="bing-tool__controls">
        <button id="btn-start" class="btn btn-primary bing-tool__button"><i class="fas fa-play"></i> Bắt đầu</button>
        <button id="btn-stop" class.="btn btn-danger bing-tool__button" style="display: none"><i class="fas fa-stop"></i> Dừng</button>
        <a href="https://rewards.bing.com/" target="_blank" class="btn btn-success bing-tool__button">
          <i class="fas fa-star"></i> Điểm
        </a>
      </div>

      <div class="bing-tool__settings">
        <a class="settings__toggle" data-bs-toggle="collapse" href="#settings-panel" role="button">
          <i class="fas fa-cog me-2"></i>Cài đặt
        </a>
        <div class="collapse settings__panel" id="settings-panel">
          </div>
      </div>
    </div>

    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const autoCloseTime = urlParams.get('autoClose');
      if (autoCloseTime) {
        let timeLeft = parseInt(autoCloseTime, 10);
        document.body.innerHTML = `<div style="display:flex; flex-direction:column; justify-content:center; align-items:center; height:100vh; font-size:2rem; font-family:sans-serif; color:#333;">
            <div id="countdown">Tự động đóng sau: ${timeLeft}s</div>
            <p style="font-size:1rem; color:#666;">Đây là tab tìm kiếm tự động.</p>
          </div>`;
        const countdownElement = document.getElementById('countdown');
        const interval = setInterval(() => {
          timeLeft--;
          if (countdownElement) {
            countdownElement.innerText = `Tự động đóng sau: ${timeLeft}s`;
          }
          if (timeLeft <= 0) {
            clearInterval(interval);
            window.close();
          }
        }, 1000);
      }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // === DOM ELEMENTS ===
        const startButton = document.getElementById('btn-start');
        const stopButton = document.getElementById('btn-stop');
        const statusDisplay = document.getElementById('status-display');
        const settingsPanel = document.getElementById('settings-panel');

        // === STATE VARIABLES ===
        const STORAGE_KEY = 'bingSearchTracker';
        const allSearchTopics = [
          'Bí ẩn về Atlantis', 'Câu chuyện về El Dorado - thành phố vàng', 'Những kho báu bị mất tích',
          'Hải tặc và những câu chuyện huyền thoại', 'Tam giác Bermuda', 'Nền văn minh Maya', 'Vườn treo Babylon',
          'Lịch sử con đường tơ lụa', 'Các vị thần Hy Lạp', 'Đấu trường La Mã', 'Kim Tự Tháp Giza', 'Tượng Nhân sư',
          'Sự kiện Roswell UFO', 'Vòng tròn bí ẩn trên cánh đồng', 'Quái vật hồ Loch Ness', 'Bigfoot và Yeti',
          'Cách mạng công nghiệp 4.0', 'Trí tuệ nhân tạo là gì', 'Công nghệ Blockchain', 'Internet of Things (IoT)',
          'Du hành thời gian có thể không', 'Lỗ đen và vũ trụ song song', 'Sự sống ngoài hành tinh',
          'Năng lượng tái tạo', 'Biến đổi khí hậu toàn cầu', 'Hệ sinh thái rừng Amazon', 'Rạn san hô Great Barrier',
          'Các loài động vật nguy cấp', 'Khám phá đáy đại dương', 'Hành trình lên sao Hỏa', 'Kính viễn vọng James Webb'
        ];
        let usedTopicsToday = [];
        let searchCounter = 0;
        let isSearching = false;
        let searchInterval;

        // === HELPER FUNCTIONS ===
        const isMobile = () => /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const getTodaysDate = () => new Date().toISOString().slice(0, 10);
        const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

        // === CORE LOGIC ===
        const loadState = () => {
          const storedData = localStorage.getItem(STORAGE_KEY);
          if (storedData) {
            const parsedData = JSON.parse(storedData);
            if (parsedData.date === getTodaysDate()) {
              usedTopicsToday = parsedData.usedTopics || [];
            }
          }
          searchCounter = usedTopicsToday.length;
        };

        const saveState = () => {
          const state = { date: getTodaysDate(), usedTopics: usedTopicsToday };
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        };

        const updateStatusDisplay = (message, statusClass = '') => {
            statusDisplay.innerHTML = message;
            statusDisplay.className = 'bing-tool__status'; // Reset
            if (statusClass) {
              statusDisplay.classList.add(statusClass);
            }
        };

        const updateUI = () => {
          const limit = getSearchLimit();
          const progress = `(${searchCounter}/${limit})`;

          if (isSearching) {
            startButton.style.display = 'none';
            stopButton.style.display = 'inline-flex';
          } else {
            startButton.style.display = 'inline-flex';
            stopButton.style.display = 'none';
          }

          if (searchCounter >= limit) {
            updateStatusDisplay(`✅ Hoàn thành ${progress}!`, 'done');
            startButton.disabled = true;
            startButton.innerHTML = `<i class="fas fa-check"></i> Xong`;
            stopSearch();
          } else {
            startButton.disabled = false;
            startButton.innerHTML = isMobile() ? `<i class="fas fa-play"></i> Mở Tab` : `<i class="fas fa-play"></i> Bắt đầu`;
            if (!isSearching) {
                updateStatusDisplay(`Sẵn sàng ${progress}`);
            }
          }
        };

        const stopSearch = () => {
          isSearching = false;
          clearInterval(searchInterval);
          updateUI();
          const limit = getSearchLimit();
          updateStatusDisplay(`Đã dừng (${searchCounter}/${limit})`);
        };

        const performSingleSearch = () => {
          const limit = getSearchLimit();
          if (searchCounter >= limit) {
            stopSearch();
            return;
          }

          const availableTopics = allSearchTopics.filter(topic => !usedTopicsToday.includes(topic));
          if (availableTopics.length === 0) {
            updateStatusDisplay('Hết chủ đề trong danh sách!', 'searching');
            stopSearch();
            return;
          }

          const randomTopic = availableTopics[Math.floor(Math.random() * availableTopics.length)];
          usedTopicsToday.push(randomTopic);
          searchCounter++;
          saveState();

          let searchURL = `https://www.bing.com/search?q=${encodeURIComponent(randomTopic)}`;
          if (isMobile()) {
            const closeDelay = document.getElementById('slc-close-delay').value;
            searchURL += `&autoClose=${closeDelay}`; // Thêm tham số để tab mới tự đóng
          }

          try {
            const openedTab = window.open(searchURL, '_blank');
            if (!openedTab) throw new Error('Pop-up bị chặn!');

            if (!isMobile()) {
               // Trên máy tính, chúng ta không thể đóng tab một cách đáng tin cậy
               // Vì vậy, chỉ cần tiếp tục vòng lặp mà không cố gắng đóng nó.
            }

          } catch (error) {
            alert('Không thể mở tab mới. Vui lòng kiểm tra và cho phép Pop-up cho trang này!');
            usedTopicsToday.pop(); // Hoàn lại trạng thái
            searchCounter--;
            saveState();
            stopSearch();
          }

          updateUI();
        };

        const startDesktopSearch = () => {
            if (isSearching) return;
            isSearching = true;
            updateUI();

            const performAndScheduleNext = () => {
                if (!isSearching) return;

                const limit = getSearchLimit();
                if (searchCounter >= limit) {
                    stopSearch();
                    return;
                }

                performSingleSearch();

                // Lên lịch cho lần tìm kiếm tiếp theo
                if (isSearching && searchCounter < limit) {
                    const delay = getRandomInt(3, 7);
                    updateStatusDisplay(`Đang tìm... (${searchCounter}/${limit}). Lần kế tiếp sau ${delay}s`, 'searching');
                    searchInterval = setTimeout(performAndScheduleNext, delay * 1000);
                } else {
                    stopSearch();
                }
            };
            performAndScheduleNext(); // Bắt đầu ngay lần đầu tiên
        };

        const getSearchLimit = () => {
          if (!isMobile()) {
            return parseInt(document.getElementById('slc-limit').value, 10);
          }
          return 90; // Giới hạn mặc định cao cho mobile vì họ tự mở
        };

        // === INITIALIZATION ===
        const initialize = () => {
          loadState();

          if (isMobile()) {
            // Giao diện cho di động
            settingsPanel.innerHTML = `
              <div class="settings__item">
                <label for="slc-close-delay" class="form-label">Tự động đóng tab sau:</label>
                <select class="form-select" id="slc-close-delay">
                  <option value="5">5 giây</option>
                  <option value="12" selected>10-15 giây (Ngẫu nhiên)</option>
                  <option value="22">15-30 giây (Ngẫu nhiên)</option>
                  <option value="300">5 phút</option>
                </select>
              </div>`;

            // Xử lý giá trị ngẫu nhiên
            const delaySelect = document.getElementById('slc-close-delay');
            delaySelect.addEventListener('change', (e) => {
                if (e.target.value === '12') e.target.value = getRandomInt(10, 15);
                if (e.target.value === '22') e.target.value = getRandomInt(15, 30);
            });
            // Thiết lập giá trị ngẫu nhiên ban đầu
            if (delaySelect.value === '12') delaySelect.value = getRandomInt(10, 15);


            startButton.addEventListener('click', performSingleSearch);
            stopButton.style.display = 'none';

          } else {
            // Giao diện cho máy tính
            settingsPanel.innerHTML = `
              <div class="settings__item">
                <label for="slc-limit" class="form-label">Số lần tìm kiếm tự động:</label>
                <select class="form-select" id="slc-limit">
                  <option value="15">15 lần</option>
                  <option value="25">25 lần</option>
                  <option value="35" selected>35 lần (Mặc định)</option>
                  <option value="45">45 lần</option>
                  <option value="55">55 lần</option>
                  <option value="65">65 lần</option>
                </select>
              </div>`;
            document.getElementById('slc-limit').addEventListener('change', updateUI);
            startButton.addEventListener('click', startDesktopSearch);
            stopButton.addEventListener('click', stopSearch);
          }
          updateUI();
        };

        initialize();
      });
    </script>
  </body>
</html>